blueprint:
  name: Dunstabzugshaube mit Kochfeld synchronisieren (Erweitert)
  description: >-
    Intelligente Steuerung der Dunstabzugshaube basierend auf dem Stromverbrauch
    des Kochfelds. Die L√ºftergeschwindigkeit passt sich automatisch an die
    Kochintensit√§t an. Mit Hysterese, gestuftem Nachlauf und Benachrichtigungen.
  domain: automation
  source_url: https://github.com/moag1000/HA-kkt-kolbe-integration/blob/main/blueprints/automation/hood_with_cooktop.yaml
  input:
    # === KOCHFELD KONFIGURATION ===
    cooktop_power_sensor:
      name: Kochfeld Stromverbrauch-Sensor
      description: >-
        Der Sensor der den aktuellen Stromverbrauch des Kochfelds misst (in Watt).
        Empfohlen: Shelly Plug oder √§hnliches Messger√§t.
      selector:
        entity:
          domain: sensor
          device_class: power

    # === DUNSTABZUGSHAUBE KONFIGURATION ===
    hood_power:
      name: Dunstabzugshaube Power
      description: Der Power-Schalter der Dunstabzugshaube
      selector:
        entity:
          domain: switch

    hood_fan:
      name: Dunstabzugshaube L√ºfter
      description: Die Fan-Entity der Dunstabzugshaube
      selector:
        entity:
          domain: fan

    hood_light:
      name: Dunstabzugshaube Licht (optional)
      description: Das Licht der Dunstabzugshaube - wird beim Kochen automatisch eingeschaltet
      default: {}
      selector:
        entity:
          domain: light

    # === POWER-SCHWELLENWERTE ===
    power_threshold_start:
      name: Start-Schwellenwert (Watt)
      description: >-
        Ab welchem Stromverbrauch soll die Haube starten?
        Typisch: 50W (Standby eines Induktionsfelds ist ca. 5-20W)
      default: 50
      selector:
        number:
          min: 10
          max: 500
          step: 10
          unit_of_measurement: "W"

    power_threshold_medium:
      name: Mittlere Leistung (Watt)
      description: >-
        Ab welchem Verbrauch soll auf mittlere Stufe gewechselt werden?
        Typisch: Eine Platte auf mittlerer Stufe (800-1200W)
      default: 1000
      selector:
        number:
          min: 200
          max: 3000
          step: 100
          unit_of_measurement: "W"

    power_threshold_high:
      name: Hohe Leistung (Watt)
      description: >-
        Ab welchem Verbrauch soll auf hohe Stufe gewechselt werden?
        Typisch: Mehrere Platten oder Boost-Modus (2500W+)
      default: 2500
      selector:
        number:
          min: 500
          max: 7500
          step: 100
          unit_of_measurement: "W"

    power_threshold_boost:
      name: Boost-Leistung (Watt)
      description: >-
        Ab welchem Verbrauch soll auf maximale Stufe gewechselt werden?
        Typisch: Mehrere Platten auf Vollgas (5000W+)
      default: 5000
      selector:
        number:
          min: 1000
          max: 10000
          step: 500
          unit_of_measurement: "W"

    # === L√úFTER-GESCHWINDIGKEITEN ===
    fan_speed_low:
      name: Niedrige Geschwindigkeit (%)
      description: L√ºftergeschwindigkeit bei leichtem Kochen (Aufw√§rmen, Simmern)
      default: 25
      selector:
        number:
          min: 25
          max: 50
          unit_of_measurement: "%"

    fan_speed_medium:
      name: Mittlere Geschwindigkeit (%)
      description: L√ºftergeschwindigkeit bei normalem Kochen (Braten, Kochen)
      default: 50
      selector:
        number:
          min: 25
          max: 75
          unit_of_measurement: "%"

    fan_speed_high:
      name: Hohe Geschwindigkeit (%)
      description: L√ºftergeschwindigkeit bei intensivem Kochen (Scharfes Anbraten)
      default: 75
      selector:
        number:
          min: 50
          max: 100
          unit_of_measurement: "%"

    fan_speed_boost:
      name: Boost-Geschwindigkeit (%)
      description: Maximale L√ºftergeschwindigkeit (Wok, starkes Braten)
      default: 100
      selector:
        number:
          min: 75
          max: 100
          unit_of_measurement: "%"

    # === HYSTERESE & STABILIT√ÑT ===
    hysteresis:
      name: Hysterese (Watt)
      description: >-
        Mindest-Differenz bevor die Stufe gewechselt wird.
        Verhindert st√§ndiges Hin- und Herschalten bei schwankendem Verbrauch.
        Empfohlen: 100-200W
      default: 150
      selector:
        number:
          min: 50
          max: 500
          step: 50
          unit_of_measurement: "W"

    min_time_per_level:
      name: Mindestzeit pro Stufe (Sekunden)
      description: >-
        Wie lange muss mindestens auf einer Stufe gelaufen werden bevor gewechselt wird?
        Verhindert hektisches Umschalten.
      default: 30
      selector:
        number:
          min: 10
          max: 120
          step: 10
          unit_of_measurement: "s"

    startup_delay:
      name: Startverz√∂gerung (Sekunden)
      description: >-
        Verz√∂gerung vor dem Einschalten der Haube.
        Verhindert Fehlstarts bei kurzen Power-Spitzen.
      default: 5
      selector:
        number:
          min: 0
          max: 30
          step: 5
          unit_of_measurement: "s"

    # === NACHLAUF-KONFIGURATION ===
    afterrun_enabled:
      name: Gestuften Nachlauf aktivieren
      description: >-
        Bei aktiviertem Nachlauf reduziert sich die Geschwindigkeit stufenweise
        bevor die Haube ausschaltet. Dies sorgt f√ºr bessere Geruchsbeseitigung.
      default: true
      selector:
        boolean:

    afterrun_time_high:
      name: Nachlauf auf mittlerer Stufe (Minuten)
      description: Wie lange auf mittlerer Stufe nachlaufen nach intensivem Kochen?
      default: 3
      selector:
        number:
          min: 0
          max: 15
          unit_of_measurement: min

    afterrun_time_medium:
      name: Nachlauf auf niedriger Stufe (Minuten)
      description: Wie lange auf niedriger Stufe nachlaufen?
      default: 5
      selector:
        number:
          min: 0
          max: 15
          unit_of_measurement: min

    afterrun_time_low:
      name: Finaler Nachlauf (Minuten)
      description: Wie lange auf minimaler Stufe laufen bevor Abschaltung?
      default: 5
      selector:
        number:
          min: 1
          max: 30
          unit_of_measurement: min

    # === LICHT & BENACHRICHTIGUNGEN ===
    turn_on_light:
      name: Licht beim Kochen einschalten
      description: Soll das Licht der Haube automatisch mit eingeschaltet werden?
      default: true
      selector:
        boolean:

    keep_light_on_afterrun:
      name: Licht w√§hrend Nachlauf anlassen
      description: Soll das Licht w√§hrend des Nachlaufs an bleiben?
      default: true
      selector:
        boolean:

    send_notifications:
      name: Benachrichtigungen senden
      description: Benachrichtigungen bei Start/Stop senden?
      default: false
      selector:
        boolean:

    notification_service:
      name: Benachrichtigungs-Service
      description: Der Service f√ºr Benachrichtigungen (z.B. notify.mobile_app_iphone)
      default: notify.notify
      selector:
        text:

    # === MANUELLE STEUERUNG ===
    respect_manual_control:
      name: Manuelle Steuerung respektieren
      description: >-
        Wenn aktiviert, wird die automatische Steuerung pausiert wenn
        die Geschwindigkeit manuell ge√§ndert wird (z.B. √ºber die App).
      default: true
      selector:
        boolean:

    manual_control_timeout:
      name: Timeout f√ºr manuelle Steuerung (Minuten)
      description: >-
        Nach wie vielen Minuten soll die automatische Steuerung wieder √ºbernehmen?
      default: 10
      selector:
        number:
          min: 5
          max: 60
          unit_of_measurement: min

variables:
  cooktop_sensor: !input cooktop_power_sensor
  hood_power_switch: !input hood_power
  hood_fan_entity: !input hood_fan
  hood_light_entity: !input hood_light
  threshold_start: !input power_threshold_start
  threshold_medium: !input power_threshold_medium
  threshold_high: !input power_threshold_high
  threshold_boost: !input power_threshold_boost
  speed_low: !input fan_speed_low
  speed_medium: !input fan_speed_medium
  speed_high: !input fan_speed_high
  speed_boost: !input fan_speed_boost
  hysteresis_value: !input hysteresis
  min_level_time: !input min_time_per_level
  afterrun_enabled: !input afterrun_enabled
  afterrun_high: !input afterrun_time_high
  afterrun_medium: !input afterrun_time_medium
  afterrun_low: !input afterrun_time_low
  light_enabled: !input turn_on_light
  light_during_afterrun: !input keep_light_on_afterrun
  notify_enabled: !input send_notifications
  respect_manual: !input respect_manual_control
  current_power: "{{ states(cooktop_sensor) | float(0) }}"
  current_speed: "{{ state_attr(hood_fan_entity, 'percentage') | int(0) }}"
  # Berechne Ziel-Geschwindigkeit mit Hysterese
  target_speed: >-
    {% set power = current_power %}
    {% set current = current_speed %}
    {% set hyst = hysteresis_value %}
    {% if power >= threshold_boost %}
      {{ speed_boost }}
    {% elif power >= threshold_high %}
      {% if current == speed_boost and power >= (threshold_boost - hyst) %}
        {{ speed_boost }}
      {% else %}
        {{ speed_high }}
      {% endif %}
    {% elif power >= threshold_medium %}
      {% if current == speed_high and power >= (threshold_high - hyst) %}
        {{ speed_high }}
      {% else %}
        {{ speed_medium }}
      {% endif %}
    {% elif power >= threshold_start %}
      {% if current == speed_medium and power >= (threshold_medium - hyst) %}
        {{ speed_medium }}
      {% else %}
        {{ speed_low }}
      {% endif %}
    {% else %}
      0
    {% endif %}
  speed_changed: "{{ target_speed | int != current_speed }}"

trigger:
  # Trigger bei Stromverbrauch √ºber Startschwelle
  - platform: numeric_state
    entity_id: !input cooktop_power_sensor
    above: !input power_threshold_start
    for:
      seconds: !input startup_delay
    id: cooking_started

  # Trigger bei Stromverbrauch unter Startschwelle (Kochen beendet)
  - platform: numeric_state
    entity_id: !input cooktop_power_sensor
    below: !input power_threshold_start
    for:
      seconds: 30
    id: cooking_stopped

  # Regelm√§√üige Aktualisierung w√§hrend des Kochens (alle 30 Sekunden)
  - platform: time_pattern
    seconds: /30
    id: periodic_update

  # Trigger bei schnellen Schwellenwert-√úberschreitungen
  - platform: numeric_state
    entity_id: !input cooktop_power_sensor
    above: !input power_threshold_medium
    id: power_increased

  - platform: numeric_state
    entity_id: !input cooktop_power_sensor
    above: !input power_threshold_high
    id: power_increased

  - platform: numeric_state
    entity_id: !input cooktop_power_sensor
    above: !input power_threshold_boost
    id: power_increased

  # Trigger bei Power-Reduzierung
  - platform: numeric_state
    entity_id: !input cooktop_power_sensor
    below: !input power_threshold_boost
    id: power_decreased

  - platform: numeric_state
    entity_id: !input cooktop_power_sensor
    below: !input power_threshold_high
    id: power_decreased

  - platform: numeric_state
    entity_id: !input cooktop_power_sensor
    below: !input power_threshold_medium
    id: power_decreased

condition: []

action:
  - choose:
      # === KOCHEN GESTARTET ===
      - conditions:
          - condition: trigger
            id: cooking_started
          - condition: state
            entity_id: !input hood_power
            state: "off"
        sequence:
          # Benachrichtigung
          - if:
              - condition: template
                value_template: "{{ notify_enabled }}"
            then:
              - service: !input notification_service
                data:
                  title: "üç≥ Kochfeld aktiv"
                  message: "Dunstabzugshaube wird automatisch eingeschaltet ({{ current_power | round(0) }}W)"
                  data:
                    tag: "hood_cooktop"

          # Haube einschalten
          - service: switch.turn_on
            target:
              entity_id: !input hood_power
          - delay:
              milliseconds: 500

          # L√ºfter auf berechnete Geschwindigkeit
          - service: fan.set_percentage
            target:
              entity_id: !input hood_fan
            data:
              percentage: "{{ target_speed }}"

          # Optional: Licht einschalten
          - if:
              - condition: template
                value_template: "{{ light_enabled and hood_light_entity }}"
            then:
              - service: light.turn_on
                target:
                  entity_id: !input hood_light

      # === LEISTUNG ERH√ñHT - SCHNELLE ANPASSUNG ===
      - conditions:
          - condition: trigger
            id: power_increased
          - condition: state
            entity_id: !input hood_power
            state: "on"
          - condition: template
            value_template: "{{ speed_changed }}"
        sequence:
          - delay:
              seconds: !input min_time_per_level
          # Nochmal pr√ºfen ob √Ñnderung noch n√∂tig
          - condition: template
            value_template: "{{ states(cooktop_sensor) | float(0) >= threshold_start }}"
          - service: fan.set_percentage
            target:
              entity_id: !input hood_fan
            data:
              percentage: "{{ target_speed }}"

      # === LEISTUNG REDUZIERT ===
      - conditions:
          - condition: trigger
            id: power_decreased
          - condition: state
            entity_id: !input hood_power
            state: "on"
          - condition: template
            value_template: "{{ speed_changed and current_power >= threshold_start }}"
        sequence:
          - delay:
              seconds: !input min_time_per_level
          # Nochmal pr√ºfen ob √Ñnderung noch n√∂tig
          - condition: template
            value_template: "{{ states(cooktop_sensor) | float(0) >= threshold_start }}"
          - service: fan.set_percentage
            target:
              entity_id: !input hood_fan
            data:
              percentage: "{{ target_speed }}"

      # === PERIODISCHE AKTUALISIERUNG ===
      - conditions:
          - condition: trigger
            id: periodic_update
          - condition: state
            entity_id: !input hood_power
            state: "on"
          - condition: template
            value_template: "{{ current_power >= threshold_start }}"
          - condition: template
            value_template: "{{ speed_changed }}"
        sequence:
          - service: fan.set_percentage
            target:
              entity_id: !input hood_fan
            data:
              percentage: "{{ target_speed }}"

      # === KOCHEN BEENDET - GESTUFTER NACHLAUF ===
      - conditions:
          - condition: trigger
            id: cooking_stopped
          - condition: state
            entity_id: !input hood_power
            state: "on"
        sequence:
          # Benachrichtigung
          - if:
              - condition: template
                value_template: "{{ notify_enabled }}"
            then:
              - service: !input notification_service
                data:
                  title: "üç≥ Kochen beendet"
                  message: >-
                    Dunstabzugshaube l√§uft noch {{ afterrun_high + afterrun_medium + afterrun_low }} Minuten nach.
                  data:
                    tag: "hood_cooktop"

          - choose:
              # Mit gestuftem Nachlauf
              - conditions:
                  - condition: template
                    value_template: "{{ afterrun_enabled }}"
                sequence:
                  # Stufe 1: Mittlere Geschwindigkeit
                  - if:
                      - condition: template
                        value_template: "{{ afterrun_high > 0 }}"
                    then:
                      - service: fan.set_percentage
                        target:
                          entity_id: !input hood_fan
                        data:
                          percentage: "{{ speed_medium }}"
                      - delay:
                          minutes: !input afterrun_time_high
                      # Pr√ºfen ob Kochfeld wieder an
                      - condition: template
                        value_template: "{{ states(cooktop_sensor) | float(0) < threshold_start }}"

                  # Stufe 2: Niedrige Geschwindigkeit
                  - if:
                      - condition: template
                        value_template: "{{ afterrun_medium > 0 }}"
                    then:
                      - service: fan.set_percentage
                        target:
                          entity_id: !input hood_fan
                        data:
                          percentage: "{{ speed_low }}"
                      - delay:
                          minutes: !input afterrun_time_medium
                      - condition: template
                        value_template: "{{ states(cooktop_sensor) | float(0) < threshold_start }}"

                  # Optional: Licht ausschalten wenn nicht w√§hrend Nachlauf gew√ºnscht
                  - if:
                      - condition: template
                        value_template: "{{ light_enabled and hood_light_entity and not light_during_afterrun }}"
                    then:
                      - service: light.turn_off
                        target:
                          entity_id: !input hood_light

                  # Stufe 3: Minimale Geschwindigkeit
                  - service: fan.set_percentage
                    target:
                      entity_id: !input hood_fan
                    data:
                      percentage: 25
                  - delay:
                      minutes: !input afterrun_time_low
                  - condition: template
                    value_template: "{{ states(cooktop_sensor) | float(0) < threshold_start }}"

                  # Alles ausschalten
                  - service: fan.turn_off
                    target:
                      entity_id: !input hood_fan
                  - delay:
                      milliseconds: 500
                  - service: switch.turn_off
                    target:
                      entity_id: !input hood_power
                  - if:
                      - condition: template
                        value_template: "{{ light_enabled and hood_light_entity }}"
                    then:
                      - service: light.turn_off
                        target:
                          entity_id: !input hood_light

                  # Finale Benachrichtigung
                  - if:
                      - condition: template
                        value_template: "{{ notify_enabled }}"
                    then:
                      - service: !input notification_service
                        data:
                          title: "üåÄ Dunstabzugshaube"
                          message: "Nachlauf beendet - Haube ausgeschaltet"
                          data:
                            tag: "hood_cooktop"

            # Ohne Nachlauf: Einfacher Nachlauf mit afterrun_low
            default:
              - service: fan.set_percentage
                target:
                  entity_id: !input hood_fan
                data:
                  percentage: 25
              - delay:
                  minutes: !input afterrun_time_low
              - condition: template
                value_template: "{{ states(cooktop_sensor) | float(0) < threshold_start }}"
              - service: fan.turn_off
                target:
                  entity_id: !input hood_fan
              - service: switch.turn_off
                target:
                  entity_id: !input hood_power
              - if:
                  - condition: template
                    value_template: "{{ light_enabled and hood_light_entity }}"
                then:
                  - service: light.turn_off
                    target:
                      entity_id: !input hood_light

mode: restart
